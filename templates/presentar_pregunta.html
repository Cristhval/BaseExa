{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>{{ examen.titulo }} - Pregunta {{ numero }}</title>
    <link rel="stylesheet" href="{% static 'css/estilo.css' %}">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f2f4f8;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }
        h2 {
            color: #2c3e50;
        }
        .pregunta {
            margin-bottom: 20px;
        }
        .respuestas label {
            display: block;
            margin-bottom: 10px;
            background: #ecf0f1;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .respuestas input[type="radio"] {
            margin-right: 10px;
        }
        .boton {
            background-color: #3498db;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
        }
        .boton:hover {
            background-color: #2980b9;
        }
        #timer {
            font-weight: bold;
            color: #e74c3c;
        }
        .feedback {
            margin-top: 15px;
            font-weight: bold;
            font-size: 1.1rem;
        }
        .feedback.correcta {
            color: #27ae60;
        }
        .feedback.incorrecta {
            color: #c0392b;
        }
        .puntaje {
            font-size: 1.1rem;
            color: #34495e;
            margin-top: 10px;
        }
        .imagen-pregunta {
            max-width: 100%;
            margin: 15px 0;
            border-radius: 10px;
        }
    </style>
</head>
<body>
<div class="container">
    <h2>{{ examen.titulo }}</h2>
    <p><strong>Pregunta {{ numero }} de {{ total }}</strong></p>
    <p><strong>Tiempo restante: <span id="timer">{{ tiempo_segundos }}s</span></strong></p>

    <form method="post" id="form-respuesta">
        {% csrf_token %}
        <div class="pregunta">
            <p>{{ pregunta.cuerpo }}</p>

            {% if pregunta.url_imagen %}
                {% if pregunta.url_imagen|slice:":4" == "http" %}
                    <img src="{{ pregunta.url_imagen }}" alt="Imagen de la pregunta" class="imagen-pregunta">
                {% else %}
                    <img src="{% static pregunta.url_imagen %}" alt="Imagen de la pregunta" class="imagen-pregunta">
                {% endif %}
            {% endif %}
        </div>

        <div class="respuestas">
            {% for respuesta in respuestas %}
                <label>
                    <input
                        type="radio"
                        name="respuesta"
                        value="{{ respuesta.id }}"
                        required
                        data-correcto="{{ respuesta.estado|yesno:'true,false' }}"
                    >
                    {{ respuesta.descripcion }}
                </label>
            {% endfor %}
        </div>

        <button type="submit" class="boton">Responder</button>
    </form>

    <div id="feedback" class="feedback" aria-live="polite"></div>
    <div id="puntaje" class="puntaje"></div>
</div>

<script>
    const tiempoInicial = {{ tiempo_segundos }};
    let tiempo = tiempoInicial;
    const timerElem = document.getElementById('timer');
    const form = document.getElementById('form-respuesta');
    const feedbackElem = document.getElementById('feedback');
    const puntajeElem = document.getElementById('puntaje');
    const totalPreguntas = {{ total }};
    const preguntaNumero = {{ numero }};
    const examenId = {{ examen.id }};
    const storageKeyPuntaje = 'puntaje_' + examenId;
    const storageKeyRespondida = `respondida_${examenId}_${preguntaNumero}`;
    let yaEnviado = false;

    // Reiniciar puntaje solo en la primera pregunta
    if (preguntaNumero === 1) {
        localStorage.setItem(storageKeyPuntaje, '0');
    }

    let puntaje = parseInt(localStorage.getItem(storageKeyPuntaje)) || 0;
    puntajeElem.textContent = `Puntaje actual: ${puntaje}`;

    const intervalo = setInterval(() => {
        tiempo--;
        timerElem.textContent = tiempo + 's';

        if (tiempo <= 0) {
            clearInterval(intervalo);
            if (!yaEnviado) {
                yaEnviado = true;
                form.submit();
            }
        }
    }, 1000);

    form.addEventListener('submit', function(event) {
        event.preventDefault();

        if (yaEnviado) return;

        const selected = form.querySelector('input[name="respuesta"]:checked');
        if (!selected) {
            feedbackElem.textContent = "No se seleccionó ninguna respuesta. Por favor, elige una.";
            feedbackElem.className = "feedback incorrecta";
            return;
        }

        // Verificar si ya se respondió
        if (localStorage.getItem(storageKeyRespondida) === '1') {
            feedbackElem.textContent = "Ya respondiste esta pregunta.";
            feedbackElem.className = "feedback incorrecta";
            return;
        }

        clearInterval(intervalo); // Detener el cronómetro
        const esCorrecta = selected.getAttribute('data-correcto') === 'true';

        if (esCorrecta) {
            feedbackElem.textContent = "✔ ¡Respuesta correcta!";
            feedbackElem.className = "feedback correcta";
            puntaje++;
            localStorage.setItem(storageKeyPuntaje, puntaje);
            puntajeElem.textContent = `Puntaje actual: ${puntaje}`;
        } else {
            feedbackElem.textContent = "✖ Respuesta incorrecta.";
            feedbackElem.className = "feedback incorrecta";
        }

        // Registrar que esta pregunta ya fue respondida
        localStorage.setItem(storageKeyRespondida, '1');

        form.querySelectorAll('input[name="respuesta"]').forEach(i => i.disabled = true);
        form.querySelector('button[type="submit"]').disabled = true;

        yaEnviado = true;

        setTimeout(() => {
            form.submit();
        }, 1200);
    });
</script>

</body>
</html>
